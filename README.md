# 智慧停車格偵測系統 (Intelligent Parking Occupancy Detection)

這是一個基於 OpenCV 與多模態影像分析的智慧停車格偵測系統。傳統的物件偵測方法在面對車輛部分遮蔽或光線不佳等情境時準確率會下降，本專案透過融合多種偵測技術，旨在建立一個更強健、更可靠的停車格佔用狀態判斷引擎。

  
*(請將此處的圖片連結替換成您自己的偵測結果範例圖)*

---

## 核心功能

-   **互動式停車格定義**: 提供一個圖形化工具 (`class.py`)，讓使用者能透過滑鼠點擊，輕鬆定義任意形狀（多邊形）的停車格，適應各種停車場佈局。
-   **多模態偵測引擎**: 系統不依賴單一方法，而是融合了三種不同的分析技術來進行交叉驗證：
    1.  **Haar 級聯分類器**: 進行基於特徵的車輛結構偵測。
    2.  **顏色分析 (HSV)**: 分析停車格區域內的顏色分佈，判斷是否有異於地面的物體。
    3.  **邊緣分析 (Canny)**: 計算區域內的邊緣密度，判斷是否存在具有複雜輪廓的物體。
-   **信賴度融合機制**: 將三種方法的結果進行加權計分，產生一個綜合信賴分數，藉此做出更可靠的佔用判斷，有效降低誤判率。
-   **清晰的視覺化結果**: 將偵測結果直接繪製在原始影像上，以不同顏色標示佔用（紅/橘）與空閒（綠）車位，並提供佔用率等即時統計數據。
-   **雙模式操作**:
    -   **單張影像分析**: 對指定的單一影像進行詳細分析與視覺化。
    -   **批次掃描模式**: 快速掃描多張停車場影像，並在終端機統一回報所有空閒車位的 ID。

---

## 專案結構

```
.
├── class.py                  # 互動式停車格定義工具
├── vehicle_detection.py      # 主要的偵測程式
├── requirements.txt          # 專案所需的 Python 套件
├── model/
│   └── cascade5.xml          # 預先訓練好的 Haar 分類器模型
├── parking_lot/
│   ├── pk1.jpg               # 範例停車場影像
│   └── ...
├── parking_lot_json/
│   ├── pk1.json              # 由 class.py 產生的停車格定義檔
│   └── ...
└── opencv_tools/             # (可選) 用於訓練模型的 OpenCV 工具
    ├── opencv_createsamples.exe
    ├── opencv_traincascade.exe
    └── opencv_world345.dll
```

---

## 安裝與設定

1.  **複製儲存庫**
    ```bash
    git clone https://github.com/rayyichen310/haar-parking-lot-detection.git
    cd haar-parking-lot-detection
    ```

2.  **安裝相依套件**
    建議先建立一個虛擬環境。本專案的核心相依套件已列在 `requirements.txt` 中。
    ```bash
    pip install -r requirements.txt
    ```

---

## 使用教學

系統的使用分為兩大步驟：先定義停車格，再執行偵測。

### 步驟一：定義停車格 (`class.py`)

此工具會為 `parking_lot` 資料夾中的每一張圖片，產生一個對應的 `JSON` 格式地圖檔，存放在 `parking_lot_json` 資料夾。

1.  **執行定義工具**:
    ```bash
    python class.py
    ```

2.  **選擇影像**: 如果有多張圖片，程式會提示您用數字選擇要處理的圖片。

3.  **繪製停車格**:
    -   **滑鼠左鍵**: 在圖片上沿著一個停車格的邊緣依序點擊頂點（建議至少4個點）。
    -   **滑鼠右鍵**: 完成當前停車格的繪製。
    -   **輸入編號**: 繪製完成後，直接用鍵盤輸入該車位的 ID (例如 `A01`)，然後按下 **Enter** 鍵確認。

4.  **儲存與操作**:
    -   `s` 鍵: 儲存所有已定義的停車格到 `JSON` 檔案。
    -   `u` 鍵: 復原上一個定義好的停車格。
    -   `r` 鍵: 重設所有定義。
    -   `q` 鍵: 退出程式。

### 步驟二：執行偵測 (`vehicle_detection.py`)

此程式會讀取影像和對應的 `JSON` 地圖檔來進行分析。

1.  **執行偵測程式**:
    ```bash
    python vehicle_detection.py
    ```

2.  **選擇模式**:
    -   輸入 `1`: 進入**單張影像分析模式**。程式會讓您選擇要分析的圖片，並顯示詳細的視覺化結果視窗。
    -   輸入 `2`: 進入**批次掃描模式**。程式會自動處理所有以 `pk` 開頭的影像，並在最後於終端機統一列出所有停車場的**可用空位 ID**。

---

## 核心技術

-   **OpenCV**: 用於所有影像讀取、處理、繪圖與 GUI 互動。
-   **NumPy**: 用於高效的數值與陣列運算。
-   **Haar 級聯分類器**: 基於 Viola-Jones 框架的快速物件偵測技術。
-   **Canny 邊緣檢測**: 用於分析影像區域的紋理複雜度。
-   **HSV 色彩空間**: 用於在不同光照條件下，更穩定地分析顏色特徵。
-   **多邊形遮罩 (Masking)**: 透過 `cv2.fillPoly` 和位元運算，精確地隔離出不規則的停車格分析區
